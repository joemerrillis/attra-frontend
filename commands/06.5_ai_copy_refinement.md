# 06.5_ai_copy_refinement.md

## üéØ Goal

Create an AI copy refinement service that takes user-written flyer copy (headline, subheadline, CTA) and optionally refines it using Claude AI. This is an **optional enhancement** feature - users can write their own copy and choose whether to use AI suggestions.

---

## üìã Prerequisites

- ‚úÖ `00_init_project.md` completed (project initialized)
- ‚úÖ `02_init_schema_design.md` completed (campaigns table exists)
- ‚úÖ `03_api_structure.md` completed (route system working)
- ‚úÖ Anthropic API key obtained

---

## üóÇÔ∏è Files Created/Modified

```
src/plugins/
 ‚îî‚îÄ ai/
     ‚îú‚îÄ aiService.js
     ‚îú‚îÄ aiController.js
     ‚îî‚îÄ index.js

src/config/
 ‚îî‚îÄ ai.js (add AI configuration)

.env (add ANTHROPIC_API_KEY)
```

---

## ‚öôÔ∏è Step 1: Add Anthropic Dependency

```bash
pnpm add @anthropic-ai/sdk
```

---

## ‚öôÔ∏è Step 2: Configure Environment Variables

Add to `.env`:
```bash
# Anthropic API Configuration
ANTHROPIC_API_KEY=sk-ant-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

# AI Rate Limiting
AI_RATE_LIMIT_PER_TENANT=50  # Max refinements per tenant per hour
AI_RATE_LIMIT_GLOBAL=500      # Max refinements globally per hour
```

Add to `.env.example`:
```bash
# Anthropic API Configuration
ANTHROPIC_API_KEY=your_anthropic_api_key_here

# AI Rate Limiting
AI_RATE_LIMIT_PER_TENANT=50
AI_RATE_LIMIT_GLOBAL=500
```

---

## ‚öôÔ∏è Step 3: Create AI Configuration

Create `src/config/ai.js`:

```js
export const AI_CONFIG = {
  model: 'claude-3-5-haiku-20241022',
  maxTokens: 300,
  temperature: 0.7,
  
  // Character limits for copy elements
  limits: {
    headline: 60,
    subheadline: 120,
    cta: 40
  },
  
  // Rate limiting
  rateLimit: {
    perTenant: parseInt(process.env.AI_RATE_LIMIT_PER_TENANT) || 50,
    global: parseInt(process.env.AI_RATE_LIMIT_GLOBAL) || 500,
    windowMs: 60 * 60 * 1000 // 1 hour
  }
};

// Vertical-specific guidance
export const VERTICAL_CONFIG = {
  dog_walking: {
    name: 'Dog Walking & Pet Care',
    audience: 'Pet owners in residential buildings',
    keyBenefits: ['trust', 'consistency', 'local', 'professional'],
    avoidWords: ['cheap', 'discount']
  },
  real_estate: {
    name: 'Real Estate Services',
    audience: 'Property owners and managers',
    keyBenefits: ['expertise', 'local knowledge', 'results', 'premium service'],
    avoidWords: ['cheap', 'basic', 'simple']
  },
  restaurant: {
    name: 'Restaurant & Food Service',
    audience: 'Local diners and food enthusiasts',
    keyBenefits: ['fresh', 'authentic', 'local', 'quality'],
    avoidWords: ['fast food', 'cheap eats']
  },
  fitness: {
    name: 'Fitness & Wellness',
    audience: 'Health-conscious residents',
    keyBenefits: ['results', 'personalized', 'convenient', 'expert trainers'],
    avoidWords: ['easy', 'quick fix']
  },
  default: {
    name: 'Service Business',
    audience: 'Local residents and businesses',
    keyBenefits: ['quality', 'local', 'trusted', 'professional'],
    avoidWords: ['cheap', 'budget']
  }
};
```

---

## ‚öôÔ∏è Step 4: Create AI Service

Create `src/plugins/ai/aiService.js`:

```js
import Anthropic from '@anthropic-ai/sdk';
import { AI_CONFIG, VERTICAL_CONFIG } from '../../config/ai.js';
import { handleServiceError } from '../../shared/errorHandler.js';
import { supabase } from '../../shared/supabaseClient.js';

const anthropic = new Anthropic({
  apiKey: process.env.ANTHROPIC_API_KEY
});

// In-memory rate limiting (use Redis in production)
const rateLimitStore = new Map();

/**
 * Check rate limits for AI requests
 */
function checkRateLimit(tenantId) {
  const now = Date.now();
  const key = `tenant:${tenantId}`;
  
  // Clean up old entries
  for (const [k, v] of rateLimitStore.entries()) {
    if (now - v.timestamp > AI_CONFIG.rateLimit.windowMs) {
      rateLimitStore.delete(k);
    }
  }
  
  // Check tenant rate limit
  const tenantRequests = rateLimitStore.get(key);
  if (tenantRequests && tenantRequests.count >= AI_CONFIG.rateLimit.perTenant) {
    return {
      allowed: false,
      reason: 'Tenant rate limit exceeded',
      retryAfter: Math.ceil((tenantRequests.timestamp + AI_CONFIG.rateLimit.windowMs - now) / 1000)
    };
  }
  
  // Check global rate limit
  const globalCount = Array.from(rateLimitStore.values())
    .filter(v => now - v.timestamp < AI_CONFIG.rateLimit.windowMs)
    .reduce((sum, v) => sum + v.count, 0);
    
  if (globalCount >= AI_CONFIG.rateLimit.global) {
    return {
      allowed: false,
      reason: 'Global rate limit exceeded',
      retryAfter: 60
    };
  }
  
  return { allowed: true };
}

/**
 * Increment rate limit counter
 */
function incrementRateLimit(tenantId) {
  const key = `tenant:${tenantId}`;
  const existing = rateLimitStore.get(key);
  
  if (existing) {
    existing.count++;
  } else {
    rateLimitStore.set(key, {
      count: 1,
      timestamp: Date.now()
    });
  }
}

/**
 * Build refinement prompt
 */
function buildPrompt(currentCopy, context) {
  const verticalConfig = VERTICAL_CONFIG[context.vertical] || VERTICAL_CONFIG.default;
  
  return `You are a direct-response copywriter helping improve flyer copy for a ${verticalConfig.name} business.

CURRENT COPY:
Headline: "${currentCopy.headline}"
Subheadline: "${currentCopy.subheadline}"
CTA: "${currentCopy.cta}"

CONTEXT:
- Business type: ${verticalConfig.name}
- Goal: ${context.goal}
- Location: ${context.location}
- Target audience: ${verticalConfig.audience}
- Key benefits to emphasize: ${verticalConfig.keyBenefits.join(', ')}
- Words to avoid: ${verticalConfig.avoidWords.join(', ')}

Your task: Refine this copy to be more compelling while preserving the user's core message and intent.

Guidelines:
1. Headline: Make it benefit-driven, not feature-driven. Create curiosity or address a pain point. Keep under ${AI_CONFIG.limits.headline} characters.
2. Subheadline: Add specificity, social proof, or local context. Build trust. Keep under ${AI_CONFIG.limits.subheadline} characters.
3. CTA: Make it action-oriented with low friction. Create urgency without being pushy. Keep under ${AI_CONFIG.limits.cta} characters.

IMPORTANT: 
- Respect the user's voice and message
- Make improvements, don't completely rewrite
- If the current copy is already good, make only minor refinements
- Focus on clarity, benefit-orientation, and persuasion

Return ONLY valid JSON (no markdown, no code blocks):
{
  "headline": "improved headline here",
  "subheadline": "improved subheadline here",
  "cta": "improved CTA here",
  "reasoning": "brief 1-2 sentence explanation of key changes made"
}`;
}

/**
 * Parse and validate AI response
 */
function parseAIResponse(text) {
  try {
    // Remove markdown code blocks if present
    const cleanText = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
    const response = JSON.parse(cleanText);
    
    // Validate response structure
    if (!response.headline || !response.subheadline || !response.cta) {
      throw new Error('Invalid response structure');
    }
    
    // Enforce character limits
    response.headline = response.headline.substring(0, AI_CONFIG.limits.headline);
    response.subheadline = response.subheadline.substring(0, AI_CONFIG.limits.subheadline);
    response.cta = response.cta.substring(0, AI_CONFIG.limits.cta);
    
    return response;
  } catch (err) {
    throw new Error(`Failed to parse AI response: ${err.message}`);
  }
}

/**
 * Refine copy using Claude AI
 */
export async function refineCopy(tenantId, params) {
  try {
    const { current_copy, context, campaign_id } = params;
    
    // Validate input
    if (!current_copy?.headline || !context?.vertical || !context?.location) {
      return {
        error: 'Missing required fields',
        details: 'current_copy.headline, context.vertical, and context.location are required'
      };
    }
    
    // Check rate limits
    const rateLimitCheck = checkRateLimit(tenantId);
    if (!rateLimitCheck.allowed) {
      return {
        error: 'Rate limit exceeded',
        details: rateLimitCheck.reason,
        retryAfter: rateLimitCheck.retryAfter
      };
    }
    
    // Build prompt
    const prompt = buildPrompt(current_copy, context);
    
    // Call Claude API
    const message = await anthropic.messages.create({
      model: AI_CONFIG.model,
      max_tokens: AI_CONFIG.maxTokens,
      temperature: AI_CONFIG.temperature,
      messages: [{
        role: 'user',
        content: prompt
      }]
    });
    
    // Parse response
    const refinedCopy = parseAIResponse(message.content[0].text);
    
    // Increment rate limit
    incrementRateLimit(tenantId);
    
    // Log the refinement (optional, for analytics)
    if (campaign_id) {
      await supabase
        .from('ai_refinement_logs')
        .insert({
          tenant_id: tenantId,
          campaign_id,
          original_copy: current_copy,
          refined_copy: refinedCopy,
          context,
          model: AI_CONFIG.model,
          tokens_used: message.usage.input_tokens + message.usage.output_tokens
        })
        .catch(err => console.error('Failed to log refinement:', err));
    }
    
    return {
      success: true,
      refined_copy: {
        headline: refinedCopy.headline,
        subheadline: refinedCopy.subheadline,
        cta: refinedCopy.cta
      },
      reasoning: refinedCopy.reasoning,
      original_copy: current_copy
    };
    
  } catch (err) {
    console.error('AI refinement error:', err);
    
    if (err.status === 429) {
      return {
        error: 'API rate limit exceeded',
        details: 'Too many requests to AI service. Please try again in a moment.'
      };
    }
    
    return handleServiceError(err, 'refineCopy');
  }
}

/**
 * Get rate limit status for a tenant
 */
export async function getRateLimitStatus(tenantId) {
  const key = `tenant:${tenantId}`;
  const tenantRequests = rateLimitStore.get(key);
  const now = Date.now();
  
  if (!tenantRequests || now - tenantRequests.timestamp > AI_CONFIG.rateLimit.windowMs) {
    return {
      used: 0,
      limit: AI_CONFIG.rateLimit.perTenant,
      resetAt: new Date(now + AI_CONFIG.rateLimit.windowMs).toISOString()
    };
  }
  
  return {
    used: tenantRequests.count,
    limit: AI_CONFIG.rateLimit.perTenant,
    resetAt: new Date(tenantRequests.timestamp + AI_CONFIG.rateLimit.windowMs).toISOString()
  };
}
```

---

## ‚öôÔ∏è Step 5: Create AI Controller

Create `src/plugins/ai/aiController.js`:

```js
import * as AIService from './aiService.js';

/**
 * Refine campaign copy
 */
export async function refineCopy(req, reply) {
  const tenantId = req.user.tenant_id || req.user.app_metadata?.tenant_id;
  const params = req.body;
  
  const result = await AIService.refineCopy(tenantId, params);
  
  if (result.error) {
    const statusCode = result.error === 'Rate limit exceeded' ? 429 : 400;
    return reply.code(statusCode).send(result);
  }
  
  reply.send(result);
}

/**
 * Get rate limit status
 */
export async function getRateLimitStatus(req, reply) {
  const tenantId = req.user.tenant_id || req.user.app_metadata?.tenant_id;
  
  const status = await AIService.getRateLimitStatus(tenantId);
  reply.send(status);
}
```

---

## ‚öôÔ∏è Step 6: Create AI Plugin

Create `src/plugins/ai/index.js`:

```js
import * as AIController from './aiController.js';

export default async function aiPlugin(fastify, options) {
  // Refine copy
  fastify.post('/ai/refine-copy', {
    schema: {
      description: 'Refine flyer copy using AI',
      tags: ['AI'],
      body: {
        type: 'object',
        required: ['current_copy', 'context'],
        properties: {
          current_copy: {
            type: 'object',
            required: ['headline'],
            properties: {
              headline: { type: 'string', maxLength: 60 },
              subheadline: { type: 'string', maxLength: 120 },
              cta: { type: 'string', maxLength: 40 }
            }
          },
          context: {
            type: 'object',
            required: ['vertical', 'location'],
            properties: {
              vertical: { type: 'string' },
              location: { type: 'string' },
              goal: { type: 'string' },
              campaign_id: { type: 'string', format: 'uuid' }
            }
          }
        }
      },
      response: {
        200: {
          type: 'object',
          properties: {
            success: { type: 'boolean' },
            refined_copy: {
              type: 'object',
              properties: {
                headline: { type: 'string' },
                subheadline: { type: 'string' },
                cta: { type: 'string' }
              }
            },
            reasoning: { type: 'string' },
            original_copy: { type: 'object' }
          }
        }
      }
    }
  }, AIController.refineCopy);
  
  // Get rate limit status
  fastify.get('/ai/rate-limit', {
    schema: {
      description: 'Get AI rate limit status for current tenant',
      tags: ['AI'],
      response: {
        200: {
          type: 'object',
          properties: {
            used: { type: 'number' },
            limit: { type: 'number' },
            resetAt: { type: 'string', format: 'date-time' }
          }
        }
      }
    }
  }, AIController.getRateLimitStatus);
}
```

---

## ‚öôÔ∏è Step 7: Register AI Plugin

Update `src/routes/index.js`:

```js
import aiPlugin from '../plugins/ai/index.js';

// Inside the internal routes register block:
await instance.register(aiPlugin, { 
  prefix: '/api/internal',
  preHandler: [verifyJWT] 
});
```

---

## ‚öôÔ∏è Step 8: Create Optional Logging Table

Create migration (optional, for analytics):

```bash
supabase migration new add_ai_refinement_logs
```

Add to migration file:

```sql
-- AI Refinement Logs (optional, for analytics)
CREATE TABLE IF NOT EXISTS public.ai_refinement_logs (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id uuid NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
  campaign_id uuid REFERENCES public.campaigns(id) ON DELETE SET NULL,
  original_copy jsonb NOT NULL,
  refined_copy jsonb NOT NULL,
  context jsonb,
  model text NOT NULL,
  tokens_used int,
  created_at timestamptz DEFAULT now()
);

CREATE INDEX idx_ai_logs_tenant ON public.ai_refinement_logs(tenant_id);
CREATE INDEX idx_ai_logs_campaign ON public.ai_refinement_logs(campaign_id);
CREATE INDEX idx_ai_logs_created ON public.ai_refinement_logs(created_at DESC);

ALTER TABLE public.ai_refinement_logs ENABLE ROW LEVEL SECURITY;

CREATE POLICY ai_logs_read_own_tenant ON public.ai_refinement_logs
  FOR SELECT
  TO authenticated
  USING (tenant_id = (auth.jwt() -> 'app_metadata' ->> 'tenant_id')::uuid);

CREATE POLICY ai_logs_service_role ON public.ai_refinement_logs
  TO service_role
  USING (true)
  WITH CHECK (true);
```

---

## ‚öôÔ∏è Step 9: Create Test Script

Create `scripts/testAIRefinement.js`:

```js
import axios from 'axios';

const BASE_URL = process.env.BASE_URL || 'http://localhost:8080';
const TEST_JWT = process.env.TEST_JWT;

const api = axios.create({
  baseURL: BASE_URL,
  headers: {
    'Authorization': `Bearer ${TEST_JWT}`
  }
});

async function testAIRefinement() {
  console.log('üß™ Testing AI Copy Refinement...\n');
  
  try {
    // Test 1: Basic refinement
    console.log('1. Testing basic refinement...');
    const { data: result1 } = await api.post('/api/internal/ai/refine-copy', {
      current_copy: {
        headline: 'Dog Walking Services',
        subheadline: 'We walk your dog',
        cta: 'Call us today'
      },
      context: {
        vertical: 'dog_walking',
        location: 'Riverside Towers',
        goal: 'new_clients'
      }
    });
    console.log('‚úÖ Refinement successful:');
    console.log(`   Original: "${result1.original_copy.headline}"`);
    console.log(`   Refined:  "${result1.refined_copy.headline}"`);
    console.log(`   Reasoning: ${result1.reasoning}\n`);
    
    // Test 2: Check rate limit status
    console.log('2. Checking rate limit status...');
    const { data: rateLimit } = await api.get('/api/internal/ai/rate-limit');
    console.log('‚úÖ Rate limit status:');
    console.log(`   Used: ${rateLimit.used}/${rateLimit.limit}`);
    console.log(`   Resets at: ${rateLimit.resetAt}\n`);
    
    // Test 3: Different vertical
    console.log('3. Testing real estate vertical...');
    const { data: result2 } = await api.post('/api/internal/ai/refine-copy', {
      current_copy: {
        headline: 'Real Estate Services',
        subheadline: 'We sell houses',
        cta: 'Contact us'
      },
      context: {
        vertical: 'real_estate',
        location: 'Downtown Chicago',
        goal: 'new_clients'
      }
    });
    console.log('‚úÖ Real estate refinement:');
    console.log(`   Refined:  "${result2.refined_copy.headline}"\n`);
    
    console.log('‚ú® All AI refinement tests passed!\n');
    
  } catch (err) {
    console.error('‚ùå Test failed:', err.response?.data || err.message);
  }
}

testAIRefinement();
```

Run:
```bash
TEST_JWT=your_token node scripts/testAIRefinement.js
```

---

## ‚öôÔ∏è Step 10: Update Documentation

Add to `docs/AI_REFINEMENT.md`:

```markdown
# AI Copy Refinement

## Overview

Attra provides optional AI-powered copy refinement for flyer campaigns. Users write their own copy, then can optionally click "AI Refine" to get suggestions.

## How It Works

1. User writes headline, subheadline, and CTA
2. User clicks "AI Refine" (optional)
3. System sends copy + context to Claude AI
4. AI returns refined version with reasoning
5. User can accept, reject, or edit further

## API Endpoint

\`\`\`http
POST /api/internal/ai/refine-copy
Authorization: Bearer {jwt_token}

{
  "current_copy": {
    "headline": "Your text here",
    "subheadline": "Your text here",
    "cta": "Your text here"
  },
  "context": {
    "vertical": "dog_walking",
    "location": "Building Name",
    "goal": "new_clients",
    "campaign_id": "uuid" // optional
  }
}
\`\`\`

## Rate Limits

- 50 refinements per tenant per hour
- 500 refinements globally per hour
- Check status: `GET /api/internal/ai/rate-limit`

## Cost

- ~$0.002 per refinement (Claude 3.5 Haiku)
- Tracked in `ai_refinement_logs` table

## Verticals Supported

- dog_walking
- real_estate
- restaurant
- fitness
- default (fallback for other verticals)

## Character Limits

- Headline: 60 characters
- Subheadline: 120 characters
- CTA: 40 characters
```

---

## ‚úÖ Completion Criteria

- ‚úÖ Anthropic SDK installed
- ‚úÖ Environment variables configured
- ‚úÖ AI service created with Claude Haiku integration
- ‚úÖ Rate limiting implemented (in-memory)
- ‚úÖ Controller and plugin created
- ‚úÖ Routes registered in main router
- ‚úÖ OpenAPI schema added
- ‚úÖ Optional logging table created
- ‚úÖ Test script validates refinement flow
- ‚úÖ Documentation created
- ‚úÖ Character limits enforced
- ‚úÖ Error handling for API failures
- ‚úÖ Vertical-specific prompts working

---

## üîú Next Steps

1. Test refinement with various copy quality levels
2. Monitor rate limits and adjust if needed
3. Add Redis for distributed rate limiting (if scaling)
4. Frontend integration in `04_build_campaign_wizard.md`

---

## üõ† Troubleshooting

### "API key not found" error:
- Verify `ANTHROPIC_API_KEY` is set in `.env`
- Restart server after adding key

### Rate limit exceeded immediately:
- Clear rate limit store: restart server
- Adjust limits in `.env`

### AI returns invalid JSON:
- Check prompt formatting
- Verify model is Haiku (not Opus/Sonnet)
- Add more validation in parseAIResponse

### Refinements not improving copy:
- Adjust temperature (lower = more conservative)
- Update prompt guidelines
- Add more vertical-specific context

---

**Note for Claude Code:** This is an optional feature. The campaign wizard should work perfectly fine without it. Users can always write their own copy and skip AI refinement entirely.
