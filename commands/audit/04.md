# ğŸ” File 04 Audit Report: Campaign Creation System

**File**: `04_build_new_campaign_creation_system.md`  
**Audit Date**: 2025-10-19  
**Status**: âš ï¸ **MISMATCHES FOUND**

---

## âœ… What's Correct

### API Client Structure
- âœ… Uses OpenAPI-generated types correctly
- âœ… Proper auth token handling from localStorage
- âœ… All endpoints match backend routes:
  - `GET /api/internal/campaigns` â†’ `listCampaigns`
  - `POST /api/internal/campaigns` â†’ `createCampaign`
  - `GET /api/internal/campaigns/:id` â†’ `getCampaign`
  - `PUT /api/internal/campaigns/:id` â†’ `updateCampaign`
  - `DELETE /api/internal/campaigns/:id` â†’ `deleteCampaign`
  - `GET /api/internal/campaigns/:id/stats` â†’ `getCampaignStats`

---

## âŒ Critical Issues Found

### Issue 1: Missing AI Endpoints in Backend
**Location**: `src/lib/ai-api.ts`

**Frontend expects**:
```typescript
POST /api/internal/ai/generate-copy
GET /api/internal/ai/rate-limit
```

**Backend reality**: 
âŒ **NO AI ENDPOINTS FOUND** in any backend command file

**Impact**: CRITICAL - AI copy generation will fail completely

**Fix Required**:
- Add AI endpoints to backend (new command file or add to existing)
- OR remove AI feature from frontend
- OR make AI optional with graceful degradation

---

### Issue 2: Missing PDF Generation Endpoints
**Location**: `src/lib/pdf-api.ts`

**Frontend expects**:
```typescript
POST /api/internal/campaigns/:campaignId/generate-pdf
GET /api/internal/campaigns/:campaignId/assets
GET /api/internal/assets/:assetId/status
```

**Backend reality**: 
âš ï¸ Partial implementation found:
- âœ… `POST /api/internal/campaigns/:id/generate-flyer` exists (different name!)
- âŒ No dedicated `/assets/:id/status` endpoint
- âš ï¸ Assets fetched via campaign relationship, not separate endpoint

**Impact**: MEDIUM - PDF generation might work but endpoints don't match

**Fix Required**:
1. Backend uses `generate-flyer`, frontend expects `generate-pdf` 
2. Either rename backend route OR update frontend to use `/generate-flyer`
3. Add asset status endpoint OR fetch status via campaign data

---

### Issue 3: QR Links Endpoint Mismatch
**Location**: `src/hooks/useQRLinks.ts`

**Frontend expects**:
```typescript
GET /api/internal/campaigns/:campaignId/qr-links
```

**Backend reality**:
âœ… QR links are returned as part of campaign data via relationship:
```javascript
.select(`*, qr_links(*)`)
```

**Impact**: LOW - Data is available, just structured differently

**Fix Required**:
- Frontend should get QR links from campaign data object
- OR backend adds dedicated qr-links endpoint

---

### Issue 4: Token Storage Assumption
**Location**: All API clients

**Frontend code**:
```typescript
const token = localStorage.getItem('supabase.auth.token');
```

**Potential issue**:
âš ï¸ Supabase stores session data, not just token. The key might be different.

**Correct approach** (from file 02):
```typescript
const { data: { session } } = await supabase.auth.getSession();
const token = session?.access_token;
```

**Impact**: MEDIUM - Auth might fail intermittently

**Fix Required**:
Update all API clients to use proper Supabase session retrieval

---

## ğŸ“Š Data Shape Compatibility

### Campaign Creation Request
**Frontend sends**:
```typescript
{
  name: string;
  description?: string;
  goal?: string;
  headline?: string;
  subheadline?: string;
  cta?: string;
  layout?: 'classic' | 'modern' | 'minimal';
  status?: 'draft' | 'active' | 'paused' | 'completed';
}
```

**Backend expects**:
```javascript
{
  tenant_id: uuid, // Added by controller
  name: string,
  // ... other fields
}
```

âœ… **Compatible** - Backend adds tenant_id from JWT

---

## ğŸ”§ Required Fixes (Priority Order)

### ğŸ”´ CRITICAL - Must Fix Before Building File 04

1. **Add AI Endpoints to Backend**
   - Create `/api/internal/ai/generate-copy` endpoint
   - Create `/api/internal/ai/rate-limit` endpoint
   - OR remove AI feature from frontend entirely
   - OR make AI completely optional with UI fallback

2. **Fix Token Retrieval**
   - Update all `api-client.ts` files to use proper session:
   ```typescript
   const { data: { session } } = await supabase.auth.getSession();
   const token = session?.access_token;
   ```

### ğŸŸ¡ HIGH - Fix Soon

3. **Align PDF Generation Endpoint**
   - Decision needed: Does backend rename to `/generate-pdf` OR frontend use `/generate-flyer`?
   - Recommendation: Backend renames for consistency with frontend expectations

4. **Add Asset Status Endpoint**
   - Backend adds: `GET /api/internal/assets/:id/status`
   - Returns: `{ status: 'pending' | 'processing' | 'completed' | 'failed', url?: string }`

### ğŸŸ¢ MEDIUM - Can Work Around

5. **Document QR Links Access Pattern**
   - Frontend should access via: `campaign.qr_links` from campaign data
   - Update frontend hook to extract from campaign response

---

## ğŸ“‹ Action Items

- [ ] Joseph decides: Keep AI feature OR remove it?
- [ ] If keeping AI: Create backend AI command file
- [ ] Fix token retrieval in all API clients
- [ ] Decide on PDF endpoint naming convention
- [ ] Add asset status endpoint to backend
- [ ] Test campaign creation flow end-to-end after fixes

---

## ğŸ¯ Recommendation

**DO NOT BUILD FILE 04 YET**. The AI endpoints are missing entirely, which means the AI copy generation feature will be completely broken. Either:

1. **Option A**: Build AI backend endpoints first (2-3 hours)
2. **Option B**: Remove AI feature from File 04 and make it manual-only (1 hour edit)
3. **Option C**: Make AI optional with graceful fallback when endpoints don't exist (1 hour edit)

Recommend **Option C** for fastest path to working MVP.
