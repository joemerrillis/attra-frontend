# ğŸ” File 05/07 Audit Report: Analytics Dashboard System

**Files**: 
- `05_build_new_analytics_dashboard.md` (Master Manifest - simplified)
- `07_build_new_analytics_dashboard_system.md` (Actual implementation)

**Audit Date**: 2025-10-19  
**Status**: âœ… **MOSTLY ALIGNED** (Minor issues)

---

## âœ… What's Correct

### Backend Infrastructure Already Built
âœ… **WebSocket Server**: `04_realtime_subscriptions.md` implemented
- `ws://api.attra.io/ws/realtime` âœ“
- Authentication via tenant_id âœ“
- Subscribe to table changes âœ“
- Broadcast INSERT/UPDATE/DELETE events âœ“

âœ… **Analytics Endpoint**: `/api/realtime/analytics` exists
- Returns dashboard snapshot âœ“
- Cached with TTL âœ“
- Tenant-scoped âœ“

âœ… **Core Entity Endpoints**:
- `GET /api/internal/campaigns` âœ“
- `GET /api/internal/qr-scans` âœ“
- `GET /api/internal/contacts` âœ“

---

## âš ï¸ Issues Found

### Issue 1: Missing QR Scans Endpoint Shape
**Location**: `src/hooks/useMapData.ts`

**Frontend expects**:
```typescript
GET /api/internal/qr-scans?limit=100
Response: {
  id: string;
  scanned_at: string;
  location: {
    id: string;
    name: string;
    coordinates: { lat: number; lng: number };
  };
  campaign: { name: string };
}[]
```

**Backend reality**:
Backend has `GET /api/internal/qr-scans` but likely returns flat data, not nested relationships.

**Impact**: MEDIUM - Frontend will need to fetch related data

**Fix Options**:
1. Backend adds nested select to qr-scans endpoint
2. Frontend does multiple queries and joins client-side (current approach)
3. Backend adds dedicated `/api/internal/map-data` endpoint with pre-joined data

**Recommendation**: Option 3 - Add dedicated map endpoint for performance

---

### Issue 2: Coordinates Field Missing in Schema
**Location**: Map data query

**Frontend expects**:
```typescript
location.coordinates: { lat: number; lng: number }
```

**Backend schema** (from 02_init_schema_design.md):
```sql
CREATE TABLE locations (
  latitude numeric,
  longitude numeric,
  -- NO coordinates JSONB field
);
```

**Impact**: MEDIUM - Query will fail

**Fix Required**:
Frontend query should use:
```typescript
location: {
  latitude: number;
  longitude: number;
}
// Then transform to { lat, lng } client-side
```

OR backend adds computed `coordinates` field to locations table

---

### Issue 3: Mapbox Dependency
**Location**: Throughout file

**Frontend requires**:
- Mapbox GL JS library
- Mapbox account + API token
- ENV var: `VITE_MAPBOX_TOKEN`

**Status**: âš ï¸ **EXTERNAL DEPENDENCY**

**Impact**: MEDIUM - Requires manual setup

**Action Required**:
- User must create Mapbox account
- Generate token
- Add to `.env` file
- Document in setup instructions

---

### Issue 4: Feature Gating Dependency
**Location**: Map access checks

**Frontend expects**:
```typescript
useFeatureGate('map_view')
useFeatureGate('realtime_map')
```

**Backend reality**:
âœ… Feature gating exists (from File 08_build_feature_gating_system.md)

**But**: Feature gating file must be built BEFORE File 05/07

**Impact**: LOW - Just build order dependency

**Fix**: Build File 08 before File 05/07

---

## ğŸ“Š Data Flow Analysis

### Dashboard Stats Flow
1. âœ… Frontend â†’ `GET /api/realtime/analytics`
2. âœ… Backend â†’ Returns cached snapshot
3. âœ… Cache updates on DB changes via WebSocket

**Status**: âœ… **WORKING**

---

### Map Pins Flow
1. Frontend â†’ `GET /api/internal/qr-scans?limit=100`
2. âŒ Backend â†’ Returns flat data (missing nested joins)
3. Frontend â†’ Manually fetches locations, campaigns
4. Frontend â†’ Client-side join + grouping

**Status**: âš ï¸ **INEFFICIENT BUT WORKABLE**

**Better approach**:
```typescript
GET /api/internal/map-data
Response: {
  pins: Array<{
    location_id, location_name, coordinates, scan_count,
    recent_scans: [{ campaign_name, scanned_at }]
  }>
}
```

---

### Real-Time Updates Flow
1. âœ… Frontend â†’ WebSocket connects to `/ws/realtime`
2. âœ… Frontend â†’ Authenticates with tenant_id
3. âœ… Frontend â†’ Subscribes to `qr_scans` table
4. âœ… Backend â†’ Broadcasts INSERT events
5. âœ… Frontend â†’ Triggers pulse animation on pin

**Status**: âœ… **FULLY WORKING**

---

## ğŸ”§ Required Fixes (Priority Order)

### ğŸŸ¡ MEDIUM - Should Fix for Better UX

1. **Add Dedicated Map Endpoint**
   ```javascript
   // Backend: src/routes/analyticsRoutes.js
   fastify.get('/api/internal/map-data', async (req, reply) => {
     const tenantId = req.user.tenant_id;
     
     // Pre-join and aggregate for frontend
     const { data } = await supabase
       .from('qr_scans')
       .select(`
         location:locations!inner(id, name, latitude, longitude),
         qr_link:qr_links!inner(campaign:campaigns(name))
       `)
       .eq('tenant_id', tenantId)
       .order('scanned_at', { ascending: false })
       .limit(1000);
     
     // Group by location
     const pins = groupByLocation(data);
     
     reply.send({ pins });
   });
   ```

2. **Fix Coordinates Field Reference**
   - Update frontend to use `{ latitude, longitude }` from DB
   - Transform to `{ lat, lng }` in `mapbox-config.ts` helper

### ğŸŸ¢ LOW - Documentation/Setup

3. **Document Mapbox Setup**
   - Add to README
   - Add to .env.example
   - Include in onboarding checklist

4. **Enforce Build Order**
   - File 08 (Feature Gating) BEFORE File 05/07
   - Update manifest dependencies

---

## ğŸ“‹ Comparison Table

| Feature | Frontend Expects | Backend Provides | Status |
|---------|-----------------|------------------|--------|
| WebSocket Server | âœ“ | âœ“ | âœ… Match |
| Analytics Snapshot | âœ“ | âœ“ | âœ… Match |
| Real-time Events | âœ“ | âœ“ | âœ… Match |
| Map Data Endpoint | Optimized | Generic | âš ï¸ Works but slow |
| Coordinates Format | `{lat,lng}` | `{latitude,longitude}` | âš ï¸ Transform needed |
| Feature Gating | âœ“ | âœ“ | âœ… Match (if built) |
| Campaign Stats | Client calc | N/A | âœ… OK |

---

## ğŸ¯ Recommendations

### Option A: Build As-Is (Fast)
- Frontend does client-side data transformation
- Slightly slower initial load
- **Time**: Can build File 05/07 immediately after File 08

### Option B: Optimize First (Better UX)
- Add `/api/internal/map-data` endpoint to backend
- Pre-aggregate for frontend
- Faster map loading
- **Time**: +1 hour backend work, then build File 05/07

### Option C: Hybrid
- Build File 05/07 with client-side transforms (works now)
- Add optimization endpoint later (v2)
- **Time**: No delay, optimize in next sprint

**My Recommendation**: **Option C** - Build now, optimize later

---

## âœ… Can Build File 05/07?

**YES** - with caveats:

### Prerequisites:
1. âœ… Backend WebSocket working (File 04 complete)
2. âš ï¸ File 08 (Feature Gating) must be built FIRST
3. âš ï¸ User must setup Mapbox account/token

### Known Limitations:
- Map data requires client-side transformation
- Initial load slightly slower than optimal
- Coordinates field name mismatch (easy fix)

### Build Blockers:
- None (assuming File 08 done first)

---

## ğŸ“ Implementation Notes

### For Frontend Build:

1. **coordinates Transform Helper**:
```typescript
// src/lib/map-utils.ts
export function normalizeCoordinates(location: any) {
  return {
    lat: location.latitude,
    lng: location.longitude
  };
}
```

2. **Map Data Aggregation**:
   - Frontend handles grouping by location
   - Uses lodash `groupBy` (already available)
   - Acceptable performance for <1000 scans

3. **Mapbox Setup Checklist**:
   - Add to `.env`: `VITE_MAPBOX_TOKEN=pk.xxx`
   - Install: `pnpm add mapbox-gl`
   - Import CSS: `import 'mapbox-gl/dist/mapbox-gl.css'`

---

## ğŸš¦ Build Decision

**APPROVED TO BUILD** after:
- âœ… File 08 (Feature Gating) complete
- âœ… Mapbox token obtained
- âœ… Frontend handles coordinates transform

**Optional backend enhancement** (can defer):
- Add `/api/internal/map-data` endpoint for better performance
