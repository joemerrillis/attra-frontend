{
  "id": "task_20251111_230800_frontend_update_api_integration",
  "from": "researcher",
  "to": "frontend",
  "timestamp": "2025-11-11T23:08:00.000Z",
  "type": "task",
  "priority": "high",
  "status": "pending",
  "subject": "IMPLEMENT: Update API Integration - Send text_elements Array",
  "body": {
    "content": "## Context\n\nNow that we have dynamic text elements in the UI, we need to update the API calls to send the `text_elements` array to the backend instead of the old `headline/subheadline/cta` structure.\n\n**Old API payload:**\n```json\n{\n  \"asset_type\": \"flyer\",\n  \"locations\": [...],\n  \"background_id\": \"...\",\n  \"headline\": \"...\",\n  \"subheadline\": \"...\",\n  \"cta\": \"...\",\n  \"text_positions\": {...},\n  \"text_colors\": {...}\n}\n```\n\n**New API payload:**\n```json\n{\n  \"asset_type\": \"flyer\",\n  \"locations\": [...],\n  \"background_id\": \"...\",\n  \"text_elements\": [\n    {\n      \"type\": \"headline\",\n      \"label\": \"Headline\",\n      \"content\": \"...\",\n      \"position\": {...},\n      \"styling\": {...},\n      \"constraints\": {...},\n      \"display_order\": 0\n    }\n  ],\n  \"qr_position\": { \"x\": 875, \"y\": 1500, \"size\": 850 }\n}\n```\n\n**This task:** Update API integration to use new payload structure.\n\n**Depends on:** task_20251111_230600 (State management with text_elements array)\n\n---\n\n## Task Breakdown\n\n### **Subtask 1: Update AssetGenerationRequest Interface**\n\n**File:** `src/types/asset.ts`\n\n**Update interface:**\n```typescript\nexport interface AssetGenerationRequest {\n  asset_type: AssetType;\n  campaign_id?: string;  // Optional\n  message_theme?: string;  // Optional\n  locations: string[];  // Array of location IDs\n  background_id: string;\n  background_mode: 'same' | 'custom';  // Keep if still needed\n  location_backgrounds?: Record<string, string>;  // Keep if still needed\n  base_url?: string;  // Keep if still needed\n  \n  // ⭐ NEW: Dynamic text elements\n  text_elements: TextElement[];\n  qr_position: QRCodePosition;\n  \n  // ❌ REMOVE (old structure):\n  // headline: string;\n  // subheadline?: string;\n  // cta?: string;\n  // text_positions?: TextPositions;\n  // text_colors?: { headline: string; subheadline: string; cta: string };\n}\n\nexport interface TextElement {\n  // NOTE: tempId is client-only, don't send to backend\n  type: 'headline' | 'subheadline' | 'body' | 'quote' | 'cta' | 'custom';\n  label: string;\n  content: string;\n  position: {\n    x: number;\n    y: number;\n    width: number;\n    height: number | null;  // null for auto-height\n  };\n  styling: {\n    fontSize: number;\n    fontWeight: 'normal' | 'bold';\n    textAlign: 'left' | 'center' | 'right' | 'justify';\n    color: string;\n    italic: boolean;\n    underline: boolean;\n    letterSpacing: number;\n    lineSpacing: number;\n  };\n  constraints?: {\n    maxLength: number;\n    required: boolean;\n  };\n  display_order: number;  // Note: snake_case for backend\n}\n\nexport interface QRCodePosition {\n  x: number;\n  y: number;\n  size: number;\n}\n```\n\n---\n\n### **Subtask 2: Create Payload Transformation Function**\n\n**File:** `src/utils/apiHelpers.ts` (new file)\n\n```typescript\nimport type { TextElement, QRCodePosition } from '@/types/asset';\n\n/**\n * Transform client TextElement to API format\n * - Removes tempId (client-only field)\n * - Converts displayOrder → display_order (camelCase → snake_case)\n * - Ensures height is null instead of 'auto' string\n */\nexport function transformTextElementForAPI(element: TextElement) {\n  const { tempId, displayOrder, ...rest } = element;\n  \n  return {\n    ...rest,\n    display_order: displayOrder,\n    position: {\n      ...element.position,\n      height: element.position.height === 'auto' ? null : element.position.height\n    }\n  };\n}\n\n/**\n * Transform array of text elements for API\n */\nexport function transformTextElementsForAPI(elements: TextElement[]) {\n  return elements\n    .filter(el => el.content.trim() !== '')  // Remove empty elements\n    .map(transformTextElementForAPI)\n    .sort((a, b) => a.display_order - b.display_order);  // Ensure sorted\n}\n\n/**\n * Validate text elements before sending\n * @returns { valid: boolean, errors: string[] }\n */\nexport function validateTextElements(elements: TextElement[]): { valid: boolean; errors: string[] } {\n  const errors: string[] = [];\n  \n  // Check for required elements\n  const hasHeadline = elements.some(el => \n    el.type === 'headline' && el.content.trim() !== ''\n  );\n  \n  if (!hasHeadline) {\n    errors.push('Headline is required');\n  }\n  \n  // Check for empty content in required elements\n  for (const el of elements) {\n    if (el.constraints?.required && el.content.trim() === '') {\n      errors.push(`${el.label} is required but empty`);\n    }\n  }\n  \n  // Check max length constraints\n  for (const el of elements) {\n    if (el.constraints?.maxLength && el.content.length > el.constraints.maxLength) {\n      errors.push(`${el.label} exceeds max length (${el.content.length}/${el.constraints.maxLength})`);\n    }\n  }\n  \n  return {\n    valid: errors.length === 0,\n    errors\n  };\n}\n```\n\n---\n\n### **Subtask 3: Update Asset Generation Function**\n\n**File:** Find where asset generation API call is made (likely in InteractiveEditor or a parent component)\n\n**Old API call:**\n```typescript\n// ❌ OLD:\nconst response = await fetch('/api/assets/generate', {\n  method: 'POST',\n  headers: { 'Content-Type': 'application/json' },\n  body: JSON.stringify({\n    asset_type: 'flyer',\n    locations: selectedLocations,\n    background_id: backgroundId,\n    headline: headline,\n    subheadline: subheadline,\n    cta: cta,\n    text_positions: textPositions,\n    text_colors: textColors\n  })\n});\n```\n\n**New API call:**\n```typescript\nimport { transformTextElementsForAPI, validateTextElements } from '@/utils/apiHelpers';\n\n// ✅ NEW:\nasync function generateAssets({\n  assetType,\n  locations,\n  backgroundId,\n  textElements,\n  qrPosition\n}: {\n  assetType: AssetType;\n  locations: string[];\n  backgroundId: string;\n  textElements: TextElement[];\n  qrPosition: QRCodePosition;\n}) {\n  // Validate before sending\n  const validation = validateTextElements(textElements);\n  if (!validation.valid) {\n    throw new Error(`Validation failed: ${validation.errors.join(', ')}`);\n  }\n  \n  // Transform to API format\n  const transformedElements = transformTextElementsForAPI(textElements);\n  \n  console.log('[API] Generating assets with:', {\n    asset_type: assetType,\n    locations: locations.length,\n    text_elements: transformedElements.length,\n    qr_position: qrPosition\n  });\n  \n  const response = await fetch('/api/assets/generate', {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify({\n      asset_type: assetType,\n      locations,\n      background_id: backgroundId,\n      text_elements: transformedElements,  // ⭐ NEW\n      qr_position: qrPosition,             // ⭐ NEW\n      message_theme: 'custom',  // Or get from wizard state\n      base_url: window.location.origin\n    })\n  });\n  \n  if (!response.ok) {\n    const error = await response.json();\n    throw new Error(error.error || 'Asset generation failed');\n  }\n  \n  return await response.json();\n}\n```\n\n---\n\n### **Subtask 4: Update InteractiveEditor onGenerate Handler**\n\n**File:** `src/components/InteractiveEditor.tsx`\n\n**Update handleGenerate:**\n```typescript\nimport { validateTextElements } from '@/utils/apiHelpers';\nimport { useToast } from '@/hooks/use-toast';\n\nconst { toast } = useToast();\n\nconst handleGenerate = () => {\n  // Filter out empty text elements\n  const nonEmptyElements = textElements.filter(el => el.content.trim() !== '');\n  \n  // Validate\n  const validation = validateTextElements(nonEmptyElements);\n  if (!validation.valid) {\n    toast({\n      title: 'Validation Error',\n      description: validation.errors.join('. '),\n      variant: 'destructive'\n    });\n    return;\n  }\n  \n  // Send to parent component\n  onGenerate({\n    text_elements: nonEmptyElements,  // ⭐ NEW: Array of text elements\n    qr_position: qrPosition           // ⭐ NEW: QR position object\n  });\n};\n```\n\n---\n\n### **Subtask 5: Update Parent Component (Wizard)**\n\n**File:** Find wizard component that calls generateAssets\n\n**Update to use new structure:**\n```typescript\n<InteractiveEditor\n  assetType={wizardState.asset_type!}\n  assetSpec={wizardState.asset_type_spec!}\n  backgroundUrl={backgroundUrl}\n  compositionMap={compositionMap}\n  onBack={() => setStep('background')}\n  onGenerate={async (data) => {\n    try {\n      setIsGenerating(true);\n      \n      // Call API with new structure\n      const result = await generateAssets({\n        assetType: wizardState.asset_type!,\n        locations: wizardState.selected_locations,\n        backgroundId: wizardState.background_id!,\n        textElements: data.text_elements,  // ⭐ NEW\n        qrPosition: data.qr_position       // ⭐ NEW\n      });\n      \n      console.log('[Wizard] Assets generated:', result);\n      \n      // Show success message\n      toast({\n        title: 'Assets Generated',\n        description: `Successfully generated ${result.assets.length} assets`\n      });\n      \n      // Navigate to next step or success page\n      onComplete(result);\n      \n    } catch (error) {\n      console.error('[Wizard] Generation failed:', error);\n      \n      toast({\n        title: 'Generation Failed',\n        description: error instanceof Error ? error.message : 'Unknown error',\n        variant: 'destructive'\n      });\n    } finally {\n      setIsGenerating(false);\n    }\n  }}\n  isGenerating={isGenerating}\n/>\n```\n\n---\n\n### **Subtask 6: Add Error Handling for API Validation**\n\n**Handle backend validation errors:**\n```typescript\ntry {\n  const result = await generateAssets({...});\n  // Success handling\n} catch (error) {\n  if (error instanceof Error) {\n    // Check if it's a validation error from backend\n    if (error.message.includes('Invalid text element')) {\n      toast({\n        title: 'Invalid Text Configuration',\n        description: 'One or more text elements have invalid positions or styling. Please adjust and try again.',\n        variant: 'destructive'\n      });\n    } else if (error.message.includes('Invalid QR code position')) {\n      toast({\n        title: 'Invalid QR Code Position',\n        description: 'QR code position is outside canvas bounds. Please reposition.',\n        variant: 'destructive'\n      });\n    } else {\n      toast({\n        title: 'Generation Failed',\n        description: error.message,\n        variant: 'destructive'\n      });\n    }\n  }\n}\n```\n\n---\n\n### **Subtask 7: Update Loading State Display**\n\n**Show progress during generation:**\n```typescript\nconst [isGenerating, setIsGenerating] = useState(false);\nconst [generationProgress, setGenerationProgress] = useState<string>('');\n\n// In generate handler:\nsetIsGenerating(true);\nsetGenerationProgress('Validating text elements...');\n\nconst validation = validateTextElements(nonEmptyElements);\nif (!validation.valid) {\n  setIsGenerating(false);\n  return;\n}\n\nsetGenerationProgress('Sending to server...');\nconst result = await generateAssets({...});\n\nsetGenerationProgress('Processing...');\n// Wait for completion\n\nsetGenerationProgress('');\nsetIsGenerating(false);\n\n// In UI:\n{isGenerating && (\n  <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50\">\n    <Card className=\"p-6\">\n      <Loader2 className=\"h-8 w-8 animate-spin mx-auto mb-4\" />\n      <p className=\"text-center\">{generationProgress}</p>\n    </Card>\n  </div>\n)}\n```\n\n---\n\n## Success Criteria\n\n- [ ] AssetGenerationRequest interface updated\n- [ ] TextElement and QRCodePosition interfaces in types\n- [ ] apiHelpers.ts created with transformation functions\n- [ ] Validation function checks for required elements\n- [ ] generateAssets function uses new payload structure\n- [ ] InteractiveEditor handleGenerate validates and sends text_elements\n- [ ] Wizard component calls API with new structure\n- [ ] Error handling for backend validation errors\n- [ ] Loading state shows progress\n- [ ] API call succeeds and returns asset IDs\n- [ ] No TypeScript errors\n\n---\n\n## Testing Checklist\n\n```bash\n# Test API integration\n1. Complete wizard to InteractiveEditor\n2. Add/edit text elements\n3. Click \"Generate Asset\"\n4. Check Network tab:\n   - POST /api/assets/generate\n   - Request payload has text_elements array\n   - Request payload has qr_position object\n   - No headline/subheadline/cta fields\n5. Verify success response\n6. Check Backend logs for worker payload\n7. Verify file_url generated for assets\n\n# Test validation\n1. Remove all text content\n2. Click Generate\n3. Verify error: \"Headline is required\"\n4. Add headline\n5. Click Generate\n6. Verify success\n```\n\n---\n\n## Example API Payload (After Transformation)\n\n```json\n{\n  \"asset_type\": \"flyer\",\n  \"locations\": [\"loc-123\", \"loc-456\"],\n  \"background_id\": \"bg-789\",\n  \"message_theme\": \"custom\",\n  \"text_elements\": [\n    {\n      \"type\": \"headline\",\n      \"label\": \"Headline\",\n      \"content\": \"Amazing Spring Sale!\",\n      \"position\": {\n        \"x\": 170,\n        \"y\": 726,\n        \"width\": 2210,\n        \"height\": null\n      },\n      \"styling\": {\n        \"fontSize\": 153,\n        \"fontWeight\": \"bold\",\n        \"textAlign\": \"center\",\n        \"color\": \"#FFFFFF\",\n        \"italic\": false,\n        \"underline\": false,\n        \"letterSpacing\": 0,\n        \"lineSpacing\": 10\n      },\n      \"constraints\": {\n        \"maxLength\": 100,\n        \"required\": true\n      },\n      \"display_order\": 0\n    },\n    {\n      \"type\": \"cta\",\n      \"label\": \"Call to Action\",\n      \"content\": \"Scan to Learn More\",\n      \"position\": {\n        \"x\": 170,\n        \"y\": 2383,\n        \"width\": 2210,\n        \"height\": null\n      },\n      \"styling\": {\n        \"fontSize\": 93,\n        \"fontWeight\": \"bold\",\n        \"textAlign\": \"center\",\n        \"color\": \"#FFFFFF\",\n        \"italic\": false,\n        \"underline\": false,\n        \"letterSpacing\": 0,\n        \"lineSpacing\": 10\n      },\n      \"constraints\": {\n        \"maxLength\": 50,\n        \"required\": true\n      },\n      \"display_order\": 2\n    }\n  ],\n  \"qr_position\": {\n    \"x\": 875,\n    \"y\": 1500,\n    \"size\": 850\n  }\n}\n```\n\n---\n\n## Notes for Frontend\n\n**Can use subagents for:**\n- Creating apiHelpers utilities (1 subagent)\n- Updating generateAssets function (1 subagent)\n- Adding error handling (1 subagent)\n- Updating wizard integration (1 subagent)\n\n**Depends on:**\n- Task 3 (text_elements array in state)\n\n**This is the final integration task** - after this, the full refactor is complete and functional end-to-end.\n\n---\n\n## Estimated Time\n\n**Total: 20 minutes**\n- Update interfaces: 5 minutes\n- Create apiHelpers: 7 minutes\n- Update API calls: 5 minutes\n- Error handling: 3 minutes",
    "attachments": [],
    "verification_checklist": [
      "AssetGenerationRequest interface updated",
      "apiHelpers.ts created with transformations",
      "Validation function works",
      "generateAssets uses new payload",
      "InteractiveEditor validates before sending",
      "Wizard calls API with new structure",
      "Error handling for validation errors",
      "Loading state shows progress",
      "API call succeeds",
      "Backend receives correct payload",
      "Assets generated with file_url",
      "No TypeScript errors"
    ]
  },
  "execution": {
    "estimated_time": "20 minutes",
    "timeout": 30,
    "complexity": "medium"
  },
  "metadata": {
    "related_files": [
      "src/types/asset.ts",
      "src/utils/apiHelpers.ts",
      "src/components/InteractiveEditor.tsx",
      "Wizard component"
    ],
    "api_endpoints": [
      "POST /api/assets/generate"
    ],
    "requires_testing": true,
    "depends_on": [
      "task_20251111_230600_frontend_refactor_interactive_editor_state"
    ]
  }
}
