{
  "id": "task_20251111_230400_frontend_asset_type_wizard_flow",
  "from": "researcher",
  "to": "frontend",
  "timestamp": "2025-11-11T23:04:00.000Z",
  "type": "task",
  "priority": "high",
  "status": "pending",
  "subject": "IMPLEMENT: Asset Type Flow Through Wizard + Fetch Specs",
  "body": {
    "content": "## Context\n\nWe're implementing an asset-type-aware system where dimensions and constraints vary by asset type (flyer, door_hanger, table_tent, business_card, menu_board).\n\n**Backend has created:**\n- `asset_type_specs` table with dimensions/constraints\n- `GET /api/asset-types` - List all types\n- `GET /api/asset-types/:type` - Get specific type specs\n- `GET /api/backgrounds?asset_type=flyer` - Filter backgrounds by type\n\n**This task:** Make asset_type flow through the entire wizard and fetch specs for use in InteractiveEditor.\n\n---\n\n## Task Breakdown\n\n### **Subtask 1: Update AssetWizard State**\n\n**File:** Find the main wizard component (likely `AssetWizard.tsx` or similar)\n\n**Add asset_type to wizard state:**\n\n```typescript\ninterface WizardState {\n  step: 'asset_type' | 'location' | 'background' | 'copy';\n  asset_type?: AssetType;  // ⭐ NEW: Store selected asset type\n  asset_type_spec?: AssetTypeSpec;  // ⭐ NEW: Store fetched specs\n  selected_locations: string[];\n  background_id?: string;\n  // ... other state\n}\n\ninterface AssetTypeSpec {\n  asset_type: string;\n  display_name: string;\n  width: number;\n  height: number;\n  aspect_ratio: string;\n  min_font_size: number;\n  max_font_size: number;\n  min_text_width: number;\n  min_text_height: number;\n  min_letter_spacing: number;\n  max_letter_spacing: number;\n  min_line_spacing: number;\n  max_line_spacing: number;\n  min_qr_size: number;\n  max_qr_size: number;\n}\n```\n\n**Initialize state:**\n\n```typescript\nconst [wizardState, setWizardState] = useState<WizardState>({\n  step: 'asset_type',\n  selected_locations: [],\n});\n```\n\n---\n\n### **Subtask 2: Create useAssetTypeSpecs Hook**\n\n**File:** `src/hooks/useAssetTypeSpecs.ts` (new file)\n\n```typescript\nimport { useState, useEffect } from 'react';\nimport { AssetType } from '@/types/asset';\n\ninterface AssetTypeSpec {\n  asset_type: string;\n  display_name: string;\n  width: number;\n  height: number;\n  aspect_ratio: string;\n  min_font_size: number;\n  max_font_size: number;\n  min_text_width: number;\n  min_text_height: number;\n  min_letter_spacing: number;\n  max_letter_spacing: number;\n  min_line_spacing: number;\n  max_line_spacing: number;\n  min_qr_size: number;\n  max_qr_size: number;\n}\n\n/**\n * Hook to fetch and cache asset type specifications\n */\nexport function useAssetTypeSpecs(assetType?: AssetType) {\n  const [spec, setSpec] = useState<AssetTypeSpec | null>(null);\n  const [loading, setLoading] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n\n  useEffect(() => {\n    if (!assetType) {\n      setSpec(null);\n      return;\n    }\n\n    async function fetchSpec() {\n      setLoading(true);\n      setError(null);\n      \n      try {\n        const response = await fetch(`/api/asset-types/${assetType}`);\n        \n        if (!response.ok) {\n          throw new Error(`Failed to fetch asset type specs: ${response.statusText}`);\n        }\n        \n        const data = await response.json();\n        setSpec(data);\n      } catch (err) {\n        setError(err instanceof Error ? err.message : 'Unknown error');\n        console.error('[useAssetTypeSpecs] Error fetching specs:', err);\n      } finally {\n        setLoading(false);\n      }\n    }\n\n    fetchSpec();\n  }, [assetType]);\n\n  return { spec, loading, error };\n}\n\n/**\n * Hook to fetch all asset type specifications\n */\nexport function useAllAssetTypeSpecs() {\n  const [specs, setSpecs] = useState<AssetTypeSpec[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n\n  useEffect(() => {\n    async function fetchAllSpecs() {\n      try {\n        const response = await fetch('/api/asset-types');\n        \n        if (!response.ok) {\n          throw new Error(`Failed to fetch asset types: ${response.statusText}`);\n        }\n        \n        const data = await response.json();\n        setSpecs(data);\n      } catch (err) {\n        setError(err instanceof Error ? err.message : 'Unknown error');\n        console.error('[useAllAssetTypeSpecs] Error fetching specs:', err);\n      } finally {\n        setLoading(false);\n      }\n    }\n\n    fetchAllSpecs();\n  }, []);\n\n  return { specs, loading, error };\n}\n```\n\n---\n\n### **Subtask 3: Update AssetTypeStep to Store Selection**\n\n**File:** Find the asset type selection component\n\n**When user selects asset type, store it AND fetch specs:**\n\n```typescript\nfunction AssetTypeStep({ onNext }: { onNext: (assetType: AssetType, spec: AssetTypeSpec) => void }) {\n  const { specs, loading, error } = useAllAssetTypeSpecs();\n  \n  const handleSelectAssetType = async (assetType: AssetType) => {\n    // Fetch specs for selected type\n    const response = await fetch(`/api/asset-types/${assetType}`);\n    const spec = await response.json();\n    \n    // Pass both asset type and specs to wizard\n    onNext(assetType, spec);\n  };\n  \n  if (loading) return <LoadingSpinner />;\n  if (error) return <ErrorMessage message={error} />;\n  \n  return (\n    <div>\n      <h2>Choose Asset Type</h2>\n      <div className=\"grid grid-cols-2 gap-4\">\n        {specs.map(spec => (\n          <AssetTypeCard\n            key={spec.asset_type}\n            type={spec}\n            onClick={() => handleSelectAssetType(spec.asset_type as AssetType)}\n          />\n        ))}\n      </div>\n    </div>\n  );\n}\n```\n\n**In wizard:**\n\n```typescript\n<AssetTypeStep \n  onNext={(assetType, spec) => {\n    setWizardState(prev => ({\n      ...prev,\n      asset_type: assetType,\n      asset_type_spec: spec,\n      step: 'location'\n    }));\n  }}\n/>\n```\n\n---\n\n### **Subtask 4: Pass asset_type to BackgroundSelector**\n\n**File:** Find BackgroundSelector component\n\n**Add asset_type prop:**\n\n```typescript\ninterface BackgroundSelectorProps {\n  assetType: AssetType;  // ⭐ NEW: Required prop\n  selectedBackgroundId?: string;\n  onSelectBackground: (backgroundId: string) => void;\n}\n\nexport function BackgroundSelector({ \n  assetType, \n  selectedBackgroundId,\n  onSelectBackground \n}: BackgroundSelectorProps) {\n  const [backgrounds, setBackgrounds] = useState<Background[]>([]);\n  const [loading, setLoading] = useState(true);\n  \n  useEffect(() => {\n    async function fetchBackgrounds() {\n      setLoading(true);\n      \n      // ⭐ Filter by asset type\n      const response = await fetch(`/api/backgrounds?asset_type=${assetType}`);\n      const data = await response.json();\n      \n      setBackgrounds(data);\n      setLoading(false);\n    }\n    \n    fetchBackgrounds();\n  }, [assetType]);  // ⭐ Re-fetch when asset type changes\n  \n  const handleGenerateNew = async () => {\n    // ⭐ Pass asset type to generation\n    const response = await fetch('/api/backgrounds/generate', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        asset_type: assetType,  // ⭐ Backend needs this for Flux aspect_ratio\n        mood: selectedMood\n      })\n    });\n    \n    const newBackground = await response.json();\n    setBackgrounds(prev => [newBackground, ...prev]);\n  };\n  \n  if (loading) return <LoadingSpinner />;\n  \n  return (\n    <div>\n      <h3>Choose Background for {assetType.replace('_', ' ')}</h3>\n      <p className=\"text-sm text-gray-600\">\n        Showing backgrounds sized for {assetType}\n      </p>\n      \n      <div className=\"grid grid-cols-3 gap-4\">\n        {backgrounds.map(bg => (\n          <BackgroundCard\n            key={bg.id}\n            background={bg}\n            selected={bg.id === selectedBackgroundId}\n            onClick={() => onSelectBackground(bg.id)}\n          />\n        ))}\n      </div>\n      \n      <Button onClick={handleGenerateNew}>\n        + Generate New {assetType.replace('_', ' ')} Background\n      </Button>\n    </div>\n  );\n}\n```\n\n**In wizard:**\n\n```typescript\n<BackgroundStep>\n  <BackgroundSelector\n    assetType={wizardState.asset_type!}  // ⭐ Pass from wizard state\n    selectedBackgroundId={wizardState.background_id}\n    onSelectBackground={(backgroundId) => {\n      setWizardState(prev => ({\n        ...prev,\n        background_id: backgroundId,\n        step: 'copy'\n      }));\n    }}\n  />\n</BackgroundStep>\n```\n\n---\n\n### **Subtask 5: Pass asset_type and spec to InteractiveEditor**\n\n**File:** Find where InteractiveEditor is rendered\n\n**Pass asset type and specs:**\n\n```typescript\n<CopyStep>\n  {wizardState.asset_type_spec ? (\n    <InteractiveEditor\n      assetType={wizardState.asset_type!}  // ⭐ NEW prop\n      assetSpec={wizardState.asset_type_spec}  // ⭐ NEW prop\n      backgroundUrl={getBackgroundUrl(wizardState.background_id)}\n      compositionMap={compositionMap}\n      onBack={() => setWizardState(prev => ({ ...prev, step: 'background' }))}\n      onGenerate={(data) => {\n        // Generate assets with asset type\n        generateAssets({\n          asset_type: wizardState.asset_type,\n          locations: wizardState.selected_locations,\n          background_id: wizardState.background_id,\n          text_elements: data.text_elements,\n          qr_position: data.qr_position\n        });\n      }}\n    />\n  ) : (\n    <LoadingSpinner message=\"Loading asset specifications...\" />\n  )}\n</CopyStep>\n```\n\n---\n\n### **Subtask 6: Update InteractiveEditor Props**\n\n**File:** `src/components/InteractiveEditor.tsx`\n\n**Update interface:**\n\n```typescript\ninterface InteractiveEditorProps {\n  assetType: AssetType;  // ⭐ NEW: Required\n  assetSpec: AssetTypeSpec;  // ⭐ NEW: Required\n  backgroundUrl: string;\n  compositionMap: any | null;\n  onBack: () => void;\n  onGenerate: (data: {\n    text_elements: TextElement[];\n    qr_position: QRCodePosition;\n  }) => void;\n  isGenerating?: boolean;\n}\n\nexport function InteractiveEditor({\n  assetType,\n  assetSpec,\n  backgroundUrl,\n  compositionMap,\n  onBack,\n  onGenerate,\n  isGenerating = false,\n}: InteractiveEditorProps) {\n  // Use assetSpec for canvas dimensions\n  const ASSET_DIMENSIONS = { \n    width: assetSpec.width, \n    height: assetSpec.height \n  };\n  const DISPLAY_SCALE = 600 / assetSpec.width;\n  \n  // ... rest of component\n}\n```\n\n---\n\n## Success Criteria\n\n- [ ] WizardState includes asset_type and asset_type_spec\n- [ ] useAssetTypeSpecs hook created and working\n- [ ] Asset type selection stores type AND fetches specs\n- [ ] BackgroundSelector receives and uses asset_type prop\n- [ ] Backgrounds filtered by asset_type in API call\n- [ ] Background generation includes asset_type\n- [ ] InteractiveEditor receives assetType and assetSpec props\n- [ ] Canvas dimensions use assetSpec values (not hardcoded 2550x3300)\n- [ ] No TypeScript errors\n- [ ] Wizard flow works end-to-end with asset type\n\n---\n\n## Testing Checklist\n\n```bash\n# Test asset type selection\n1. Start wizard\n2. Select \"Door Hanger\" asset type\n3. Verify specs fetched (check Network tab: GET /api/asset-types/door_hanger)\n4. Proceed to backgrounds\n5. Verify backgrounds filtered (check Network tab: GET /api/backgrounds?asset_type=door_hanger)\n6. Generate new background\n7. Verify asset_type sent (check Network tab: POST /api/backgrounds/generate with asset_type)\n8. Proceed to copy editor\n9. Verify canvas dimensions match door_hanger (1200x3000, not 2550x3300)\n```\n\n---\n\n## Notes for Frontend\n\n**Can use subagents for:**\n- Creating useAssetTypeSpecs hook (1 subagent)\n- Updating BackgroundSelector (1 subagent)\n- Updating wizard state flow (1 subagent)\n- Updating InteractiveEditor props (1 subagent)\n\n**This task is foundational:**\n- Other frontend tasks depend on this completing first\n- Provides asset_type and assetSpec to all downstream components\n\n---\n\n## Estimated Time\n\n**Total: 20 minutes**\n- Wizard state updates: 5 minutes\n- useAssetTypeSpecs hook: 5 minutes\n- BackgroundSelector updates: 5 minutes\n- InteractiveEditor prop updates: 5 minutes",
    "attachments": [],
    "verification_checklist": [
      "Wizard state includes asset_type and asset_type_spec",
      "useAssetTypeSpecs hook created",
      "Asset type selection fetches and stores specs",
      "BackgroundSelector filters by asset_type",
      "Background generation includes asset_type",
      "InteractiveEditor receives assetSpec",
      "Canvas uses dynamic dimensions from spec",
      "No TypeScript errors",
      "End-to-end wizard flow works"
    ]
  },
  "execution": {
    "estimated_time": "20 minutes",
    "timeout": 30,
    "complexity": "medium"
  },
  "metadata": {
    "related_files": [
      "Wizard component",
      "src/hooks/useAssetTypeSpecs.ts",
      "BackgroundSelector component",
      "InteractiveEditor component"
    ],
    "api_endpoints": [
      "GET /api/asset-types",
      "GET /api/asset-types/:type",
      "GET /api/backgrounds?asset_type=X",
      "POST /api/backgrounds/generate"
    ],
    "requires_testing": true
  }
}
